# Compiler and flags
CC = gcc
CFLAGS = -Wall -Wextra -pedantic -std=c11
LDFLAGS = -lpthread

# Targets for our programs
CLIENT = client
SERVER_BASIC = server
SERVER_MULTITHREAD = server_multithread

# Source files
CLIENT_SRC = client.c
SERVER_BASIC_SRC = server.c
SERVER_MULTITHREAD_SRC = server_multithread.c

# Default target: compile both the client and the multithreaded server
all: $(CLIENT) $(SERVER_MULTITHREAD)

# Rule to compile the client program
$(CLIENT): $(CLIENT_SRC)
	@echo "Compiling client program..."
	$(CC) $(CFLAGS) $(CLIENT_SRC) -o $(CLIENT)
	@echo "Client compiled successfully!"

# Rule to compile the basic server program (single-client version)
$(SERVER_BASIC): $(SERVER_BASIC_SRC)
	@echo "Compiling basic server program..."
	$(CC) $(CFLAGS) $(SERVER_BASIC_SRC) -o $(SERVER_BASIC)
	@echo "Basic server compiled successfully!"

# Rule to compile the multithreaded server program (supports multiple clients)
$(SERVER_MULTITHREAD): $(SERVER_MULTITHREAD_SRC)
	@echo "Compiling multithreaded server program..."
	$(CC) $(CFLAGS) $(SERVER_MULTITHREAD_SRC) -o $(SERVER_MULTITHREAD) $(LDFLAGS)
	@echo "Multithreaded server compiled successfully!"

# Rule to remove all compiled binaries
clean:
	@echo "Cleaning up..."
	rm -f $(CLIENT) $(SERVER_BASIC) $(SERVER_MULTITHREAD)
	@echo "All binaries removed!"

# Rule to clean and recompile everything
rebuild: clean all

# Help message for guidance
help:
	@echo "Usage of the Makefile:"
	@echo "  make                 : Compile both client and multithreaded server"
	@echo "  make client          : Compile only the client program"
	@echo "  make server          : Compile only the basic server program"
	@echo "  make server_multithread : Compile only the multithreaded server program"
	@echo "  make clean           : Remove all compiled binaries"
	@echo "  make rebuild         : Clean and recompile everything from scratch"
	@echo "  make run_server      : Run the multithreaded server"
	@echo "  make run_client      : Run the client program"

# Rule to run the multithreaded server
run_server:
	@echo "Running the multithreaded server..."
	./$(SERVER_MULTITHREAD)

# Rule to run the client
run_client:
	@echo "Running the client..."
	./$(CLIENT) 127.0.0.1 65100
