#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <arpa/inet.h>

#define BUFFER_SIZE 2 // Size of the messages exchanged (2 bytes)

// Define protocol messages
#define TOO_LOW -1
#define TOO_HIGH 1
#define WIN 0
#define LOSE 2

int main(int argc, char *argv[]) {
    // Step 1: Check if the correct number of arguments is provided
    if (argc != 3) {
        fprintf(stderr, "Usage: %s <SERVER_IP> <PORT>\n", argv[0]);
        exit(EXIT_FAILURE); 
    }

    const char* server_ip = argv[1];
    int port = atoi(argv[2]);

    int sock_fd;
    struct sockaddr_in server_addr;
    signed char buffer[BUFFER_SIZE];
    int interval_min, interval_max;
    int guess;

    // Step 2: Create the client socket
    sock_fd = socket(AF_INET, SOCK_STREAM, 0);
    if (sock_fd < 0) {
        perror("Socket creation failed");
        exit(EXIT_FAILURE);
    }

    // Step 3: Setup server address structure
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(port);

    // Convert IPv4 Address from text to binary form
    if (inet_pton(AF_INET, server_ip, &server_addr.sin_addr) <= 0) {
        perror("Invalid address/Address not supported");
        close(sock_fd);
        exit(EXIT_FAILURE);
    }

    // Step 4: Connect to the server
    if (connect(sock_fd, (struct sockaddr *)&server_addr, sizeof(server_addr)) < 0) {
        perror("Connection to the server failed");
        close(sock_fd);
        exit(EXIT_FAILURE);
    }

    printf("Connected to the server at %s:%d\n", server_ip, port);

    // Step 5: Receive the initialization message (interval_min and interval_max) from the server
    if (read(sock_fd, buffer, BUFFER_SIZE) < 0) {
        perror("Failed to receive data from server");
        close(sock_fd);
        exit(EXIT_FAILURE);
    }

    interval_min = buffer[0];
    interval_max = buffer[1];
    printf("Guess a number between %d and %d\n", interval_min, interval_max);
    
    // Step 6: Game loop - send guesses to the server 
    while (1) {
        // Get user input for the guess
        printf("Enter your guess: ");
        if (scanf("%d", &guess) != 1) {
            fprintf(stderr, "Invalid input. Please enter a valid number.\n");
            while (getchar() != '\n'); // Clear the input buffer
            continue;
        }

        // Prepare the buffer to send the guess to the server
        buffer[0] = 0;
        buffer[1] = guess;

        // Send the guess to the server
        if (write(sock_fd, buffer, BUFFER_SIZE) < 0) {
            perror("Failed to send data to server");
            break;
        }
        printf("Proposition sent: %d\n", guess);

        // Receive the server's response 
        if (read(sock_fd, buffer, BUFFER_SIZE) < 0) {
            perror("Failed to receive response from server");
            break;
        }

        int response = buffer[0];
        int real_value = buffer[1]; // For debugging, server sends back the actual number 
        printf("Server says: ");

        // Interpret the server's response 
        if (response == TOO_LOW) {
            printf("Too low!\n");
        } else if (response == TOO_HIGH) {
            printf("Too high!\n");
        } else if (response == WIN) {
            printf("You won! The number was %d\n", real_value);
            break;
        } else if (response == LOSE) {
            printf("You lost! The number was %d\n", real_value);
            break;
        } else {
            printf("Unknown response from server\n");
            break;
        }
    }

    // Step 7: Close the socket and exit
    close(sock_fd);
    printf("Connection closed.\n");

    return 0;
}
